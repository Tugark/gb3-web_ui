<mat-card appearance="outlined" class="map-catalogue-widget">
  <mat-card-header class="map-catalogue__header">
    <div class="map-catalogue__header__title">
      <mat-card-title>Verf√ºgbare Karten nach Topic</mat-card-title>
    </div>
  </mat-card-header>
  <div class="map-catalogue__filter">
    <input class="map-catalogue__filter__input" type="text" placeholder="Karten und Layer filtern" #filterInput />
    <mat-icon class="map-catalogue__filter__input-icon">search</mat-icon>
  </div>
  <loading-and-process-bar [loadingState]="this.loadingState"></loading-and-process-bar>
  <mat-accordion *ngIf="this.loadingState === 'loaded'" class="map-catalogue__content" displayMode="flat" multi="true">
    <ng-container *ngFor="let topic of topics; trackBy: trackByTopicTitle">
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <p [matBadgeHidden]="!this.filterString" [matBadge]="topic.maps.length" matBadgeOverlap="false" matBadgePosition="above after">
            {{ topic.title }}
          </p>
        </mat-expansion-panel-header>
        <!-- Expansion panel content -->
        <ng-template matExpansionPanelContent>
          <ng-container *ngFor="let map of topic.maps; trackBy: trackByMapId">
            <mat-expansion-panel #mapExpansionPanel hideToggle="true">
              <mat-expansion-panel-header (click)="mapExpansionPanel.toggle()" class="map__header">
                <button (click)="addActiveMap(map)" color="primary" data-test-id="add-active-map" mat-icon-button>
                  <mat-icon>add</mat-icon>
                </button>
                <button
                  (click)="mapExpansionPanel.toggle()"
                  [attr.data-test-id]="mapExpansionPanel.expanded ? 'hide-layers-of-the-map' : 'show-layers-of-the-map'"
                  mat-icon-button
                  [disabled]="map.layers.length === 0"
                >
                  <mat-icon
                    [fontIcon]="mapExpansionPanel.expanded ? 'arrow_drop_down' : 'arrow_right'"
                    [matBadgeHidden]="!this.filterString"
                    [matBadge]="map.layers.length"
                    [matBadgeDisabled]="map.layers.length === 0"
                    matBadgeOverlap
                  ></mat-icon>
                </button>
                <img [alt]="map.title" [src]="map.icon" class="map__header__image" />
                <p
                  [innerHTML]="map.title | highlightSearchQuery : this.filterString"
                  class="map__header__title"
                  matTooltip="{{ map.title }}"
                ></p>
              </mat-expansion-panel-header>
              <!-- Expansion panel content -->
              <ng-template matExpansionPanelContent>
                <ng-container *ngFor="let layer of map.layers">
                  <div *ngIf="!layer.isHidden" class="layer">
                    <mat-icon class="layer__icon">layers</mat-icon>
                    <p
                      [innerHTML]="layer.title | highlightSearchQuery : this.filterString"
                      class="layer__title"
                      matTooltip="{{ layer.title }}"
                    ></p>
                    <button (click)="addActiveLayer(map, layer)" mat-icon-button>
                      <mat-icon>add</mat-icon>
                    </button>
                  </div>
                </ng-container>
              </ng-template>
            </mat-expansion-panel>
          </ng-container>
        </ng-template>
      </mat-expansion-panel>
    </ng-container>
  </mat-accordion>
</mat-card>
